<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NaviGuide AI</title>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background: #0f172a;
  color: white;
  padding: 10px;
}

video {
  width: 90%;
  max-width: 500px;
  border-radius: 15px;
  border: 2px solid #38bdf8;
}

#output {
  margin-top: 15px;
  background: #020617;
  padding: 10px;
  border-radius: 10px;
  min-height: 80px;
  width: 90%;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
  white-space: pre-wrap;
}

button {
  margin: 10px;
  padding: 10px 15px;
  border-radius: 10px;
  border: none;
  background: #38bdf8;
  color: black;
  font-weight: bold;
}
</style>
</head>

<body>

<h2>NAVIGUIDE AI â€” CÃ¡mara en tiempo real</h2>

<video id="video" autoplay playsinline></video>
<br>

<button id="flipBtn">ðŸ”„ Cambiar cÃ¡mara</button>

<p id="status">Estado: conectando...</p>

<h3>IA dice:</h3>
<div id="output">Esperando detecciones...</div>

<script>
const video = document.getElementById("video");
const output = document.getElementById("output");
const status = document.getElementById("status");

let useFrontCamera = false;

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: useFrontCamera ? "user" : "environment" }
  });
  video.srcObject = stream;
}

startCamera();

// === TU CONEXIÃ“N REAL CON NGROK (YA CORREGIDA) ===
const ws = new WebSocket(
  "wss://zaida-distinguishing-unhistorically.ngrok-free.dev/stream"
);

ws.onopen = () => {
  status.textContent = "Estado: CONECTADO âœ…";
  console.log("Conectado al backend");
};

ws.onerror = () => {
  status.textContent = "Estado: ERROR DE CONEXIÃ“N âŒ";
};

ws.onmessage = (event) => {
  // Muestra bonito el JSON que manda tu backend
  try {
    const data = JSON.parse(event.data);
    output.textContent =
      "âš ï¸ ALERTA: " + data.alerta + "\n" +
      "âž¡ï¸ NAVEGACIÃ“N: " + data.navegacion + "\n" +
      "ðŸ“ GRAFO: tÃº â†’ " + data.grafo.nodo_objeto +
      " (" + data.grafo.distancia_cm + " cm)";
  } catch {
    output.textContent = event.data;
  }
};

// Enviar frames cada 500 ms
setInterval(() => {
  if (video.videoWidth === 0) return;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  const base64 = canvas.toDataURL("image/jpeg").split(",")[1];

  if (ws.readyState === WebSocket.OPEN) {
    ws.send(base64);
  }
}, 500);

// BotÃ³n para voltear cÃ¡mara
document.getElementById("flipBtn").onclick = async () => {
  useFrontCamera = !useFrontCamera;
  video.srcObject.getTracks().forEach(t => t.stop());
  await startCamera();
};
</script>

</body>
</html>
